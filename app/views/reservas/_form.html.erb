<% hospedes_options = @hospedes_options || Hospede.order(:nome) %>
<% hotels_options = @hotels_options || Hotel.order(:nome) %>
<% status_choices = [["Confirmada", "Confirmada"], ["Pendente", "Pendente"], ["Cancelada", "Cancelada"]] %>

<%= form_with(model: reserva, local: true, class: "row g-3 form-grid") do |form| %>
  <% if reserva.errors.any? %>
    <div class="col-12">
      <div class="toast-glow flash-banner flash-banner--danger" role="alert">
        <h2 class="h5 mb-3"><%= pluralize(reserva.errors.count, "erro") %> impediram o salvamento:</h2>
        <ul class="mb-0">
          <% reserva.errors.full_messages.each do |message| %>
            <li><%= message %></li>
          <% end %>
        </ul>
      </div>
    </div>
  <% end %>

  <div class="col-12 col-md-6">
    <% hospede_errors = form.object.errors[:hospede_id].presence || form.object.errors[:hospede] %>
    <%= form.label :hospede_id, "Hóspede", class: "form-label" %>
    <%= form.collection_select :hospede_id, hospedes_options, :id, :nome,
                               { prompt: hospedes_options.any? ? "Selecione o hóspede" : "Nenhum hóspede cadastrado" },
                               class: "form-select #{'is-invalid' if hospede_errors.present?}" %>
    <% if hospede_errors.present? %>
      <div class="invalid-feedback"><%= hospede_errors.first %></div>
    <% elsif hospedes_options.blank? %>
      <p class="form-text text-muted mb-0">Cadastre um hóspede antes de finalizar a reserva.</p>
    <% end %>
  </div>

  <div class="col-12 col-md-6">
    <% hotel_errors = form.object.errors[:hotel_id].presence || form.object.errors[:hotel] %>
    <%= form.label :hotel_id, "Hotel", class: "form-label" %>
    <%= form.collection_select :hotel_id, hotels_options, :id, :nome,
                               { prompt: hotels_options.any? ? "Selecione o hotel" : "Nenhum hotel cadastrado" },
                               class: "form-select #{'is-invalid' if hotel_errors.present?}" %>
    <% if hotel_errors.present? %>
      <div class="invalid-feedback"><%= hotel_errors.first %></div>
    <% elsif hotels_options.blank? %>
      <p class="form-text text-muted mb-0">Cadastre um hotel para disponibilizá-lo aqui.</p>
    <% end %>
  </div>

  <div class="col-12 col-md-6">
    <%= form.label :data_checkin, class: "form-label" %>
    <%= form.date_field :data_checkin, class: "form-control #{'is-invalid' if form.object.errors[:data_checkin].present?}" %>
    <% if form.object.errors[:data_checkin].present? %>
      <div class="invalid-feedback"><%= form.object.errors[:data_checkin].first %></div>
    <% end %>
  </div>

  <div class="col-12 col-md-6">
    <%= form.label :data_checkout, class: "form-label" %>
    <%= form.date_field :data_checkout, class: "form-control #{'is-invalid' if form.object.errors[:data_checkout].present?}" %>
    <% if form.object.errors[:data_checkout].present? %>
      <div class="invalid-feedback"><%= form.object.errors[:data_checkout].first %></div>
    <% end %>
  </div>

  <div class="col-12 col-md-6">
    <%= form.label :status, class: "form-label" %>
    <%= form.select :status, status_choices, { prompt: "Selecione o status" }, class: "form-select #{'is-invalid' if form.object.errors[:status].present?}" %>
    <% if form.object.errors[:status].present? %>
      <div class="invalid-feedback"><%= form.object.errors[:status].first %></div>
    <% end %>
  </div>

  <div class="col-12 col-md-6">
    <%= form.label :valor_total, class: "form-label" %>
    <div class="input-group">
      <span class="input-group-text">R$</span>
      <%= form.number_field :valor_total, step: 0.01, class: "form-control #{'is-invalid' if form.object.errors[:valor_total].present?}" %>
    </div>
    <% if form.object.errors[:valor_total].present? %>
      <div class="invalid-feedback d-block"><%= form.object.errors[:valor_total].first %></div>
    <% end %>
  </div>

  <div class="col-12 d-flex flex-wrap gap-2 justify-content-end">
    <%= form.submit reserva.persisted? ? "Atualizar reserva" : "Criar reserva", class: "btn btn-gradient" %>
    <% if hospedes_options.blank? %>
      <%= link_to "Cadastrar hóspede", new_hospede_path, class: "btn btn-outline-secondary" %>
    <% end %>
  </div>
<% end %>
