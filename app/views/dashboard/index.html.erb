<% content_for :title, (current_user.admin? ? "Painel" : "Área do hóspede") %>

<% if current_user.admin? %>
  <div class="page-header">
    <div class="stack-sm">
      <span class="page-eyebrow"><i class="bi bi-speedometer2"></i> Operação em foco</span>
      <h1 class="page-header__title">Painel de operações</h1>
      <p class="page-header__subtitle">Resumo do dia com métricas essenciais, exportações rápidas e o panorama das reservas mais recentes.</p>
    </div>
    <div class="page-actions">
      <%= link_to "Nova reserva", new_reserva_path, class: "btn btn-gradient" %>
      <%= link_to "Exportar hotéis", "#export-csv", class: "btn btn-outline-secondary" %>
    </div>
  </div>

  <div class="dashboard-metrics mb-5">
    <div class="metric-card">
      <div class="metric-card-content">
        <div class="metric-icon"><i class="bi bi-building"></i></div>
        <p class="text-uppercase small text-muted fw-semibold mb-1">Hotéis ativos</p>
        <p class="display-6 fw-bold mb-3"><%= @hotels_count %></p>
        <%= link_to "Gerenciar hotéis", hotels_path, class: "btn btn-link p-0 fw-semibold" %>
      </div>
    </div>
    <div class="metric-card">
      <div class="metric-card-content">
        <div class="metric-icon"><i class="bi bi-calendar-check"></i></div>
        <p class="text-uppercase small text-muted fw-semibold mb-1">Reservas registradas</p>
        <p class="display-6 fw-bold mb-3"><%= @reservas_count %></p>
        <%= link_to "Ver reservas", reservas_path, class: "btn btn-link p-0 fw-semibold" %>
      </div>
    </div>
    <div class="metric-card">
      <div class="metric-card-content">
        <div class="metric-icon"><i class="bi bi-people"></i></div>
        <p class="text-uppercase small text-muted fw-semibold mb-1">Hóspedes cadastrados</p>
        <p class="display-6 fw-bold mb-3"><%= @hospedes_count %></p>
        <%= link_to "Ver hóspedes", hospedes_path, class: "btn btn-link p-0 fw-semibold" %>
      </div>
    </div>
  </div>

  <div class="surface-card surface-card--compact stack-md mb-5">
    <div class="d-flex flex-column flex-lg-row justify-content-between align-items-start align-items-lg-center gap-3">
      <div>
        <h2 class="h5 mb-1">Visibilidade operacional</h2>
        <p class="text-muted mb-0">Sinalizamos reservas que precisam de ação da equipe enquanto usamos a verificação demo (código 0000).</p>
      </div>
      <div class="d-flex flex-wrap gap-2">
        <span class="badge bg-warning-subtle text-warning">Telefone pendente: <%= @reservas_sem_verificacao_count %></span>
        <span class="badge bg-info-subtle text-info">Prontas para confirmar: <%= @reservas_prontas_confirmacao_count %></span>
      </div>
    </div>

    <div class="row g-4">
      <div class="col-12 col-lg-6">
        <div class="surface-card surface-card--flush table-card h-100">
          <div class="table-card__header">
            <div>
              <span class="page-eyebrow d-inline-flex align-items-center gap-2"><i class="bi bi-exclamation-circle"></i> Aguardando verificação</span>
              <h3 class="table-card__title">Telefone ainda não confirmado</h3>
            </div>
            <%= link_to "Abrir CRM", incompletas_reservas_path(anchor: "verificacao"), class: "btn btn-sm btn-outline-secondary" %>
          </div>
          <% if @reservas_sem_verificacao.any? %>
            <div class="table-card__body">
              <div class="table-responsive">
                <table class="table align-middle mb-0">
                  <thead>
                    <tr>
                      <th>Hóspede</th>
                      <th>Telefone</th>
                      <th>Criada em</th>
                    </tr>
                  </thead>
                  <tbody>
                    <% @reservas_sem_verificacao.each do |reserva| %>
                      <tr>
                        <td>
                          <div class="d-flex align-items-center gap-2">
                            <div class="hc-avatar"><%= reserva.hospede.nome.first.upcase %></div>
                            <div>
                              <div class="fw-semibold"><%= reserva.hospede.nome %></div>
                              <div class="text-muted small"><%= reserva.hospede.email %></div>
                            </div>
                          </div>
                        </td>
                        <td><%= reserva.hospede.telefone %></td>
                        <td><%= l(reserva.created_at, format: :short) %></td>
                      </tr>
                    <% end %>
                  </tbody>
                </table>
              </div>
            </div>
          <% else %>
            <div class="empty-state mb-0">
              <div class="empty-state__icon"><i class="bi bi-check-circle"></i></div>
              <p class="mb-0">Nenhuma reserva aguardando verificação de telefone.</p>
            </div>
          <% end %>
        </div>
      </div>
      <div class="col-12 col-lg-6">
        <div class="surface-card surface-card--flush table-card h-100">
          <div class="table-card__header">
            <div>
              <span class="page-eyebrow d-inline-flex align-items-center gap-2"><i class="bi bi-patch-check"></i> Prontas para confirmar</span>
              <h3 class="table-card__title">Esperando ação da equipe</h3>
            </div>
            <%= link_to "Abrir CRM", incompletas_reservas_path(anchor: "confirmar"), class: "btn btn-sm btn-outline-secondary" %>
          </div>
          <% if @reservas_prontas_confirmacao.any? %>
            <div class="table-card__body">
              <div class="table-responsive">
                <table class="table align-middle mb-0">
                  <thead>
                    <tr>
                      <th>Hóspede</th>
                      <th>Hotel</th>
                      <th>Check-in</th>
                      <th></th>
                    </tr>
                  </thead>
                  <tbody>
                    <% @reservas_prontas_confirmacao.each do |reserva| %>
                      <tr>
                        <td>
                          <div class="d-flex align-items-center gap-2">
                            <div class="hc-avatar"><%= reserva.hospede.nome.first.upcase %></div>
                            <div>
                              <div class="fw-semibold"><%= reserva.hospede.nome %></div>
                              <div class="text-muted small">Verificado em <%= l(reserva.hospede.phone_verified_at, format: :short) %></div>
                            </div>
                          </div>
                        </td>
                        <td><%= reserva.hotel.nome %></td>
                        <td><%= l(reserva.data_checkin) %></td>
                        <td class="text-end">
                          <%= button_to confirmar_reserva_path(reserva), method: :post, class: "btn btn-sm btn-gradient" do %>
                            Confirmar
                          <% end %>
                        </td>
                      </tr>
                    <% end %>
                  </tbody>
                </table>
              </div>
            </div>
          <% else %>
            <div class="empty-state mb-0">
              <div class="empty-state__icon"><i class="bi bi-emoji-smile"></i></div>
              <p class="mb-0">Nenhuma reserva aguardando confirmação final.</p>
            </div>
          <% end %>
        </div>
      </div>
    </div>

    <div class="d-flex justify-content-end">
    <%= link_to "Ver painel CRM completo", incompletas_reservas_path, class: "btn btn-outline-secondary" %>
    </div>
  </div>

  <div id="export-hub" class="dashboard-export surface-card surface-card--compact stack-md mb-5">
    <div class="dashboard-export__header">
      <div class="stack-sm mb-0">
        <h2 class="h5 fw-semibold mb-0">Central de exportação</h2>
        <p class="text-muted mb-0">Escolha o conjunto de dados, defina filtros opcionais ou exporte tudo em CSV ou PDF.</p>
      </div>
      <span class="badge-gradient badge">Acesso administrativo</span>
    </div>

    <form id="dashboard-export-form"
          class="dashboard-export__form stack-md"
          data-export-paths='<%= {
            hotels: export_hotels_path,
            hospedes: export_hospedes_path,
            reservas: export_reservas_path
          }.to_json %>'>
      <div class="dashboard-export__fields">
        <div class="dashboard-export__field">
          <span class="dashboard-export__label">Tipo de dado</span>
          <div class="btn-group" role="group" aria-label="Tipo de dado">
            <input type="radio" class="btn-check" name="export_resource" id="export-resource-hotels" value="hotels" autocomplete="off" checked>
            <label class="btn btn-outline-secondary" for="export-resource-hotels">Hotéis</label>

            <input type="radio" class="btn-check" name="export_resource" id="export-resource-hospedes" value="hospedes" autocomplete="off">
            <label class="btn btn-outline-secondary" for="export-resource-hospedes">Hóspedes</label>

            <input type="radio" class="btn-check" name="export_resource" id="export-resource-reservas" value="reservas" autocomplete="off">
            <label class="btn btn-outline-secondary" for="export-resource-reservas">Reservas</label>
          </div>
        </div>

        <div class="dashboard-export__field">
          <span class="dashboard-export__label">Formato</span>
          <div class="btn-group" role="group" aria-label="Formato">
            <input type="radio" class="btn-check" name="export_format" id="export-format-csv" value="csv" autocomplete="off" checked>
            <label class="btn btn-outline-secondary" for="export-format-csv">CSV</label>

            <input type="radio" class="btn-check" name="export_format" id="export-format-pdf" value="pdf" autocomplete="off">
            <label class="btn btn-outline-secondary" for="export-format-pdf">PDF</label>
          </div>
        </div>

        <div class="dashboard-export__field">
          <span class="dashboard-export__label">Escopo</span>
          <div class="btn-group" role="group" aria-label="Escopo">
            <input type="radio" class="btn-check" name="export_scope" id="export-scope-filtered" value="filtered" autocomplete="off" checked>
            <label class="btn btn-outline-secondary" for="export-scope-filtered">Filtros aplicados</label>

            <input type="radio" class="btn-check" name="export_scope" id="export-scope-all" value="all" autocomplete="off">
            <label class="btn btn-outline-secondary" for="export-scope-all">Todos os registros</label>
          </div>
        </div>
      </div>

      <div class="dashboard-export__filter-group" data-export-filters data-resource="hotels">
        <div class="dashboard-export__fields">
          <div class="dashboard-export__field">
            <label class="form-label fw-semibold" for="export-hotel-city">Cidade</label>
            <select class="form-select" id="export-hotel-city" name="cidade">
              <option value="">Selecione a cidade</option>
              <% @hotel_filter_cities.each do |city| %>
                <option value="<%= city %>"><%= city %></option>
              <% end %>
            </select>
          </div>
          <div class="dashboard-export__field">
            <label class="form-label fw-semibold" for="export-hotel-category">Categoria</label>
            <select class="form-select" id="export-hotel-category" name="categoria">
              <option value="">Selecione a categoria</option>
              <% @hotel_filter_categories.each do |category| %>
                <option value="<%= category %>"><%= category %></option>
              <% end %>
            </select>
          </div>
        </div>
      </div>

      <div class="dashboard-export__filter-group d-none" data-export-filters data-resource="hospedes">
        <div class="dashboard-export__fields">
          <div class="dashboard-export__field">
            <label class="form-label fw-semibold" for="export-hospede-nome">Nome</label>
            <input type="text" class="form-control" id="export-hospede-nome" name="nome" placeholder="Ex.: Maria">
          </div>
          <div class="dashboard-export__field">
            <label class="form-label fw-semibold" for="export-hospede-documento">Documento</label>
            <input type="text" class="form-control" id="export-hospede-documento" name="documento" placeholder="CPF ou RG">
          </div>
          <div class="dashboard-export__field">
            <label class="form-label fw-semibold" for="export-hospede-email">E-mail</label>
            <input type="email" class="form-control" id="export-hospede-email" name="email" placeholder="contato@exemplo.com">
          </div>
        </div>
      </div>

      <div class="dashboard-export__filter-group d-none" data-export-filters data-resource="reservas">
        <div class="dashboard-export__fields">
          <div class="dashboard-export__field">
            <label class="form-label fw-semibold" for="export-reserva-hospede">Hóspede</label>
            <input type="text" class="form-control" id="export-reserva-hospede" name="hospede_nome" placeholder="Nome do hóspede">
          </div>
          <div class="dashboard-export__field">
            <label class="form-label fw-semibold" for="export-reserva-hotel">Hotel</label>
            <input type="text" class="form-control" id="export-reserva-hotel" name="hotel_nome" placeholder="Nome do hotel">
          </div>
        </div>
        <div class="dashboard-export__fields">
          <div class="dashboard-export__field">
            <label class="form-label fw-semibold" for="export-reserva-checkin">Check-in a partir de</label>
            <input type="date" class="form-control" id="export-reserva-checkin" name="data_checkin">
          </div>
          <div class="dashboard-export__field">
            <label class="form-label fw-semibold" for="export-reserva-checkout">Check-out até</label>
            <input type="date" class="form-control" id="export-reserva-checkout" name="data_checkout">
          </div>
          <div class="dashboard-export__field">
            <label class="form-label fw-semibold" for="export-reserva-status">Status</label>
            <select class="form-select" id="export-reserva-status" name="status">
              <option value="">Todos</option>
              <% @reserva_statuses.each do |status| %>
                <option value="<%= status %>"><%= status.titleize %></option>
              <% end %>
            </select>
          </div>
        </div>
      </div>

      <div class="dashboard-export__actions">
        <button type="submit" class="btn btn-gradient d-inline-flex align-items-center gap-2">
          <i class="bi bi-cloud-arrow-down"></i>
          Gerar arquivo
        </button>
        <button type="reset" class="btn btn-outline-secondary" data-export-reset>
          Limpar filtros
        </button>
      </div>
    </form>

    <p class="text-muted small mb-0">Escolha "Todos os registros" para gerar relatórios completos sem filtros.</p>
  </div>

  <div class="row g-4 align-items-start mb-5">
    <div class="col-12 col-xl-7">
      <div class="surface-card surface-card--compact stack-md h-100">
        <div>
          <span class="page-eyebrow d-inline-flex align-items-center gap-2"><i class="bi bi-door-open"></i> Estadias em andamento</span>
          <h2 class="h5 mb-0">Check-ins ativos</h2>
        </div>
        <% if @active_stays.any? %>
          <ul class="list-group">
            <% @active_stays.each do |reserva| %>
              <li class="list-group-item d-flex justify-content-between align-items-center flex-wrap gap-3">
                <div class="d-flex align-items-center gap-3">
                  <div class="hc-avatar"><%= reserva.hospede.nome.first.upcase %></div>
                  <div>
                    <div class="fw-semibold"><%= reserva.hospede.nome %></div>
                    <div class="text-muted small">
                      No <%= reserva.hotel.nome %> — check-in em <%= l(reserva.check_in_at || reserva.data_checkin, format: :short) %>
                    </div>
                  </div>
                </div>
                <div class="d-flex align-items-center gap-2">
                  <% since_label = reserva.check_in_at.present? ? l(reserva.check_in_at, format: :short) : "Horário não informado" %>
                  <span class="badge bg-info-subtle text-info">Desde <%= since_label %></span>
                  <%= link_to "Detalhes", reserva_path(reserva), class: "btn btn-sm btn-outline-secondary" %>
                </div>
              </li>
            <% end %>
          </ul>
        <% else %>
          <div class="empty-state mb-0">
            <div class="empty-state__icon"><i class="bi bi-door-closed"></i></div>
            <p class="mb-0">Nenhum hóspede marcado como em estadia no momento.</p>
          </div>
        <% end %>
        <hr class="my-3">
        <div>
          <span class="page-eyebrow d-inline-flex align-items-center gap-2"><i class="bi bi-hourglass-split"></i> Próximas operações</span>
          <h3 class="h6 mb-0">Reservas aguardando ação</h3>
        </div>
        <% if @awaiting_operations.any? %>
          <div class="table-responsive">
            <table class="table table-sm align-middle mb-0">
              <thead>
                <tr>
                  <th>Hóspede</th>
                  <th>Hotel</th>
                  <th>Check-in previsto</th>
                  <th></th>
                </tr>
              </thead>
              <tbody>
                <% @awaiting_operations.each do |reserva| %>
                  <tr>
                    <td>
                      <div class="fw-semibold"><%= reserva.hospede.nome %></div>
                      <div class="text-muted small"><%= reserva.hospede.telefone %></div>
                    </td>
                    <td><%= reserva.hotel.nome %></td>
                    <td><%= l(reserva.data_checkin) %></td>
                    <td class="text-end">
                      <% if reserva.can_be_confirmed? %>
                        <%= button_to confirmar_reserva_path(reserva), method: :post, class: "btn btn-sm btn-gradient" do %>
                          Confirmar
                        <% end %>
                      <% else %>
                        <%= link_to "Ver detalhes", reserva_path(reserva), class: "btn btn-sm btn-outline-secondary" %>
                      <% end %>
                    </td>
                  </tr>
                <% end %>
              </tbody>
            </table>
          </div>
        <% else %>
          <div class="empty-state mb-0">
            <div class="empty-state__icon"><i class="bi bi-emoji-smile"></i></div>
            <p class="mb-0">Nenhuma reserva pendente de operação imediata.</p>
          </div>
        <% end %>
      </div>
    </div>
    <div class="col-12 col-xl-5">
      <div class="surface-card surface-card--compact stack-md h-100">
        <div>
          <span class="page-eyebrow d-inline-flex align-items-center gap-2"><i class="bi bi-activity"></i> Linha do tempo operacional</span>
          <h2 class="h5 mb-0">Eventos recentes</h2>
          <p class="text-muted mb-0">Atualizações registradas nas últimas reservas.</p>
        </div>
        <% if @operations_timeline.any? %>
          <ul class="timeline-list mt-2">
            <% @operations_timeline.each do |event| %>
              <% reserva = event.reserva %>
              <li class="timeline-list__item d-flex align-items-start gap-3 py-2 border-bottom">
                <span class="timeline-icon text-primary"><i class="bi <%= event.icon_name %>"></i></span>
                <div>
                  <div class="d-flex flex-wrap gap-2 align-items-center">
                    <strong><%= event.human_label %></strong>
                    <% if evento_time = event.timestamp %>
                      <small class="text-muted"><%= l(evento_time, format: :short) %></small>
                    <% end %>
                  </div>
                  <% if event.details_message.present? %>
                    <small class="d-block text-muted"><%= event.details_message %></small>
                  <% end %>
                  <% if reserva.present? %>
                    <% hospede = reserva.hospede %>
                    <% hotel = reserva.hotel %>
                    <small class="d-block text-muted">
                      Reserva #<%= reserva.id %>
                      <% if hospede.present? %>
                        • <%= hospede.nome %>
                      <% end %>
                      <% if hotel.present? %>
                        @ <%= hotel.nome %>
                      <% end %>
                    </small>
                  <% else %>
                    <small class="d-block text-muted">Reserva removida</small>
                  <% end %>
                </div>
              </li>
            <% end %>
          </ul>
        <% else %>
          <div class="empty-state mb-0">
            <div class="empty-state__icon"><i class="bi bi-infinity"></i></div>
            <p class="mb-0">Ainda não há eventos registrados no histórico.</p>
          </div>
        <% end %>
      </div>
    </div>
  </div>

  <div class="row g-4 align-items-start">
    <div class="col-12 col-lg-7">
      <div class="surface-card surface-card--flush table-card h-100">
        <div class="table-card__header">
          <div>
            <span class="page-eyebrow d-inline-flex align-items-center gap-2"><i class="bi bi-calendar2-week"></i> Últimas reservas</span>
            <h2 class="table-card__title">Movimento mais recente</h2>
          </div>
          <%= link_to "Ver todas", reservas_path, class: "btn btn-sm btn-outline-secondary" %>
        </div>
        <% if @latest_reservas.present? %>
          <div class="table-card__body">
            <div class="table-responsive">
              <table class="table align-middle">
                <thead>
                  <tr>
                    <th>Hóspede</th>
                    <th>Hotel</th>
                    <th>Check-in</th>
                    <th>Status</th>
                    <th></th>
                  </tr>
                </thead>
                <tbody>
                  <% @latest_reservas.each do |reserva| %>
                    <tr>
                      <td>
                        <div class="d-flex align-items-center gap-3">
                          <div class="hc-avatar"><%= reserva.hospede.nome.first.upcase %></div>
                          <div>
                            <div class="fw-semibold"><%= reserva.hospede.nome %></div>
                            <div class="text-muted small"><%= reserva.hospede.email %></div>
                          </div>
                        </div>
                      </td>
                      <td><%= reserva.hotel.nome %></td>
                      <td><%= l(reserva.data_checkin) %></td>
                      <td>
                        <% status_class = case reserva.status
                          when "reservada" then "status-chip--warning"
                          when "confirmada" then "status-chip--success"
                          when "cancelada" then "status-chip--danger"
                          else "status-chip--default"
                        end %>
                        <span class="status-chip <%= status_class %>"><%= reserva.status.titleize %></span>
                      </td>
                      <td class="text-end">
                        <%= link_to reserva_path(reserva), class: "btn btn-sm btn-outline-secondary" do %>
                          Ver detalhes <i class="bi bi-arrow-up-right"></i>
                        <% end %>
                      </td>
                    </tr>
                  <% end %>
                </tbody>
              </table>
            </div>
          </div>
        <% else %>
          <div class="empty-state">
            <div class="empty-state__icon"><i class="bi bi-calendar-minus"></i></div>
            <p class="mb-0">Nenhuma reserva registrada recentemente.</p>
          </div>
        <% end %>
      </div>
    </div>
    <div class="col-12 col-lg-5">
      <div class="action-panel h-100">
        <span class="action-panel__title">Ações rápidas</span>
        <div class="action-panel__group">
          <%= link_to new_hotel_path, class: "btn btn-outline-secondary d-flex justify-content-between align-items-center" do %>
            <span>Cadastrar novo hotel</span>
            <i class="bi bi-arrow-up-right"></i>
          <% end %>
          <%= link_to new_hospede_path, class: "btn btn-outline-secondary d-flex justify-content-between align-items-center" do %>
            <span>Cadastrar hóspede</span>
            <i class="bi bi-person-plus"></i>
          <% end %>
          <%= link_to new_reserva_path, class: "btn btn-outline-secondary d-flex justify-content-between align-items-center" do %>
            <span>Gerar reserva</span>
            <i class="bi bi-calendar-plus"></i>
          <% end %>
          <button class="btn btn-outline-secondary d-flex justify-content-between align-items-center" disabled>
            <span>Relatórios (em breve)</span>
            <i class="bi bi-clock-history"></i>
          </button>
        </div>
      </div>
    </div>
  </div>

  <%= javascript_tag do %>
    (function() {
      function initDashboardExport() {
        var form = document.getElementById("dashboard-export-form");
        if (!form || form.dataset.enhanced === "true") { return; }
        form.dataset.enhanced = "true";

        var exportPaths = {};
        try {
          exportPaths = JSON.parse(form.dataset.exportPaths || "{}");
        } catch (error) {
          exportPaths = {};
        }

        var datasetRadios = form.querySelectorAll("input[name='export_resource']");
        var formatRadios = form.querySelectorAll("input[name='export_format']");
        var scopeRadios = form.querySelectorAll("input[name='export_scope']");
        var filterGroups = form.querySelectorAll("[data-export-filters]");
        var resetButton = form.querySelector('[data-export-reset]');

        function activeDataset() {
          var checked = form.querySelector("input[name='export_resource']:checked");
          return checked ? checked.value : null;
        }

        function activeScope() {
          var checked = form.querySelector("input[name='export_scope']:checked");
          return checked ? checked.value : "filtered";
        }

        function updateFilterGroups() {
          var dataset = activeDataset();
          filterGroups.forEach(function(group) {
            if (group.dataset.resource === dataset) {
              group.classList.remove("d-none");
            } else {
              group.classList.add("d-none");
            }
          });
          toggleFiltersAccessibility();
        }

        function toggleFiltersAccessibility() {
          var dataset = activeDataset();
          var scope = activeScope();
          filterGroups.forEach(function(group) {
            var disable = scope === "all" || group.dataset.resource !== dataset;
            group.querySelectorAll("input, select, textarea").forEach(function(field) {
              field.disabled = disable;
            });
          });
        }

        function gatherFilters(dataset) {
          var params = new URLSearchParams();
          var group = form.querySelector('[data-export-filters][data-resource="' + dataset + '"]');
          if (!group) { return params; }

          group.querySelectorAll("input, select, textarea").forEach(function(field) {
            if (!field.name || field.disabled || !field.value) { return; }
            params.append(field.name, field.value);
          });

          return params;
        }

        datasetRadios.forEach(function(radio) {
          radio.addEventListener("change", updateFilterGroups);
        });

        scopeRadios.forEach(function(radio) {
          radio.addEventListener("change", toggleFiltersAccessibility);
        });

        if (resetButton) {
          resetButton.addEventListener("click", function() {
            filterGroups.forEach(function(group) {
              group.querySelectorAll("input, select, textarea").forEach(function(field) {
                if (field.type === "radio" || field.type === "checkbox") {
                  field.checked = false;
                } else {
                  field.value = "";
                }
              });
            });
            // reset scope to filtered after clearing
            var filteredRadio = form.querySelector("#export-scope-filtered");
            if (filteredRadio) { filteredRadio.checked = true; }
            toggleFiltersAccessibility();
          });
        }

        form.addEventListener("submit", function(event) {
          event.preventDefault();

          var dataset = activeDataset();
          var format = form.querySelector("input[name='export_format']:checked");
          var scope = activeScope();

          if (!dataset || !format) {
            alert("Selecione o tipo de dado e o formato do arquivo.");
            return;
          }

          var basePath = exportPaths[dataset];
          if (!basePath) {
            alert("Não foi possível determinar o endereço de exportação.");
            return;
          }

          var params = new URLSearchParams();
          params.append("export_scope", scope);

          if (scope !== "all") {
            var filterParams = gatherFilters(dataset);
            filterParams.forEach(function(value, key) {
              params.append(key, value);
            });
          }

          var queryString = params.toString();
          var url = basePath + "." + format.value + (queryString ? "?" + queryString : "");
          window.location.href = url;
        });

        updateFilterGroups();
      }

      document.addEventListener("turbo:load", initDashboardExport);
      document.addEventListener("DOMContentLoaded", initDashboardExport);
    })();
  <% end %>
<% else %>
  <div class="surface-card surface-card--compact stack-md">
    <h1 class="h4 fw-semibold mb-0">Área do hóspede</h1>
    <p class="text-muted mb-0">Não encontramos um cadastro de hóspede associado ao seu usuário. Entre em contato com nossa equipe para liberar o acesso às reservas.</p>
    <div class="d-flex flex-wrap gap-3">
      <%= link_to "Falar com a recepção", "mailto:contato@hotelconstantino.com", class: "btn btn-outline-secondary" %>
      <%= link_to "Voltar para a página inicial", home_path, class: "btn btn-gradient" %>
    </div>
  </div>
<% end %>
